{
  "hash": "8af68a79887d668c8f6c77c849cec6c4",
  "result": {
    "engine": "julia",
    "markdown": "---\ntitle: \"Example: Poisson Regression\"\nexecute:\n    error: true\n    warning: true\nengine: julia\njulia:\n    exeflags: [\"+1.11.5\"]\nformat:\n  html: default  \n  typst: default\n  ipynb: default   \nformat-links:\n    - format: typst\n      text: PDF\n      icon: file-earmark-pdf\n    - format: ipynb  \n      text: Jupyter\n      icon: journal-code\n---\n\n::: {.cell execution_count=1}\n``` {.julia .cell-code}\nusing DataFrames\nusing CSV\nusing Statistics\nusing Distributions\nusing Optim\nusing Plots\nusing StatsPlots\n```\n:::\n\n\n\nThis is an example of setting up, fitting, checking, and modifying a generalized linear model (GLM). We'll use a dataset of fish caught by visitors at a National Park:\n\n::: {.cell execution_count=1}\n``` {.julia .cell-code}\nfish = CSV.File(\"data/Fish.csv\") |> DataFrame\nfish[1:3, :]\n```\n\n::: {.cell-output .cell-output-display execution_count=1}\n```\n3×6 DataFrame\n Row │ fish_caught  livebait  camper  persons  child  hours   \n     │ Int64        Int64     Int64   Int64    Int64  Float64 \n─────┼────────────────────────────────────────────────────────\n   1 │           0         0       0        1      0   21.124\n   2 │           0         1       1        1      0    5.732\n   3 │           0         1       0        1      0    1.323\n```\n:::\n:::\n\n\n\nThe data includes the number of fish caught by visitors, whether they used live bait, whether they brought a camper van, the number of children and persons in the party, and how many hours they spent in the park.\n\n## Exploratory Analysis\n\nLet's plot a histogram of the number of caught fish (our response variable), as well as explore the relationship between the potential predictors and the response.\n\n::: {.cell execution_count=1}\n``` {.julia .cell-code}\nhistogram(fish.fish_caught, xlabel=\"Number of Fish Caught\", ylabel=\"Count\", legend=false)\n```\n\n::: {.cell-output .cell-output-display execution_count=1}\n![Histogram of the number of fish caught.](poisson-regression_files/figure-typst/fig-fish-hist-output-1.svg){#fig-fish-hist}\n:::\n:::\n\n\n\nWe can see from @fig-fish-count that there are quite a large number of zeros, and the data is quite dispersed: it has a mean of 3\\.3 and a variance of 135\\.4.\n\n::: {#fig-fish-scatter .cell subfig-cap='[\"Live bait use\",\"Camper use\",\"Number of children in party\",\"Number of persons in party\",\"Number of hours in park\"]' ncol-display='2' execution_count=1}\n``` {.julia .cell-code}\np1 = boxplot(fish.livebait, fish.fish_caught, xlabel=\"Live Bait Use\", ylabel=\"Fish Caught\", legend=false)\np2 = boxplot(fish.camper, fish.fish_caught, xlabel=\"Camper Van Use\", ylabel=\"Fish Caught\", legend=false)\np3 = boxplot(fish.child, fish.fish_caught, xlabel=\"Number of Children\", ylabel=\"Fish Caught\", legend=false)\np4 = boxplot(fish.persons, fish.fish_caught, xlabel=\"Number of Persons\", ylabel=\"Fish Caught\", legend=false)\np5 = scatter(fish.hours, fish.fish_caught, xlabel=\"Hours in Park\", ylabel=\"Fish Caught\", legend=false)\ndisplay(p1)\ndisplay(p2)\ndisplay(p3)\ndisplay(p4)\ndisplay(p5)\n```\n\n::: {.cell-output .cell-output-display}\n![Exploratory analysis of predictor variable relationship with the number of fish caught.](poisson-regression_files/figure-typst/fig-fish-scatter-output-1.svg){#fig-fish-scatter-1}\n:::\n\n::: {.cell-output .cell-output-display}\n![](poisson-regression_files/figure-typst/fig-fish-scatter-output-2.svg){#fig-fish-scatter-2}\n:::\n\n::: {.cell-output .cell-output-display}\n![](poisson-regression_files/figure-typst/fig-fish-scatter-output-3.svg){#fig-fish-scatter-3}\n:::\n\n::: {.cell-output .cell-output-display}\n![](poisson-regression_files/figure-typst/fig-fish-scatter-output-4.svg){#fig-fish-scatter-4}\n:::\n\n::: {.cell-output .cell-output-display}\n![](poisson-regression_files/figure-typst/fig-fish-scatter-output-5.svg){#fig-fish-scatter-5}\n:::\n:::\n\n\n\n## Poisson Regression\n\n### Model Specification\n\nA GLM requires us to specify three things:\n\n1. The distribution of the response variable $y$;\n2. Link function(s) for the parameters which are modeled;\n3. A linear model for the transformed parameters (through the reverse link).\n\nFrom @fig-fish-scatter, it appears as though there are relationships between the number of fish caught and the live bait, camper, child, and person variables, but not the number of hours (as groups might be doing something other than fishing for a while). The strongest impact are live bait and camper use, so let's see how correlated these are to decide if we ought to include them as separate predictors.\n\n::: {.cell execution_count=1}\n``` {.julia .cell-code}\n@show sum(fish.camper[fish.livebait .== 0]) / nrow(fish);\n@show sum(fish.camper[fish.livebait .== 1]) / nrow(fish);\n@show sum(fish.livebait[fish.camper .== 0]) / nrow(fish);\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nsum(fish.camper[fish.livebait .== 0]) / nrow(fish) = 0.064\nsum(fish.camper[fish.livebait .== 1]) / nrow(fish) = 0.524\nsum(fish.livebait[fish.camper .== 0]) / nrow(fish) = 0.34\n```\n:::\n:::\n\n\n\nSo only 6.4% of the groups that did not use live bait used a camper, while 52% of the groups that did use live bait used a camper, and 34% of groups which did not use a camper used live bait. That suggests there is a relationship between the two that we could capture with the camper variable, but there could be extra information from the live bait variable. \n\nAs a result, we might hypothesize that the number of fish caught is influenced by the number of children (noisy, distracting, impatient) and whether the party brought a camper. We'll hold off on including the live bait variable for now. As we're modeling counts of caught fish, a Poisson distribution is the typical starting point^[As noted earlier, the variance of the caught fish distribution is much larger than the mean, which would normally suggest that a Poisson distribution is not a good choice. However, that is the distribution *after the influence of covariates*, which would produce different Poissons for different predictors and could result in that level of overdispersion. We can't know without fitting the model and testing it if the distribution predicted by the GLM will have these properties! It's important not to over-interpret the raw histogram.], and the most flexible link for the Poisson rate $\\lambda$ is the log. This would give us the following GLM:\n\n$$\\begin{align*}\ny_i &\\sim \\text{Poisson}(\\lambda_i) \\\\\nf(\\lambda_i) &= \\beta_0 + \\beta_1 \\text{child}_i + \\beta_2 \\text{camper}_i\n\\end{align*}\n$$\n\n### Fitting The Poisson Model\n\nWe'll use numerical optimization to fit the model, using the basic optimization routine `Optim.optimize()`. We won't tweak the settings and will give the optimizer a pretty broad range of parameters to work with.\n\n::: {.cell execution_count=1}\n``` {.julia .cell-code}\nfunction fish_model(params, child, camper, fish_caught)\n    β₀, β₁, β₂ = params\n    λ = exp.(β₀ .+ β₁ * child + β₂ * camper)\n    ll = sum(logpdf.(Poisson.(λ), fish_caught))\n    return ll\nend\n\nlb = [-100.0, -100.0, -100.0] # lower bounds\nub = [100.0, 100.0, 100.0] # upper bounds\ninit = [0.0, 0.0, 0.0] # initial guesses\n\noptim_out = optimize(θ -> -fish_model(θ, fish.child, fish.camper, fish.fish_caught), lb, ub, init)\nθ_mle = optim_out.minimizer\n@show round.(θ_mle; digits=2);\n@show round.(exp.(θ_mle); digits=2);\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nround.(θ_mle; digits = 2) = [0.91, -1.23, 1.05]\nround.(exp.(θ_mle); digits = 2) = [2.48, 0.29, 2.87]\n```\n:::\n:::\n\n\n\nSo, **under this model specification**, the base odds of catching a fish are 2.5, which are decreased by a factor of 0.29 for every additional child in the group, and increased by a factor of almost 3 if a camper is used. How do we know if this model works well?\n\n",
    "supporting": [
      "poisson-regression_files/figure-typst"
    ],
    "filters": []
  }
}